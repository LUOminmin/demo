(function(t){function e(e){for(var i,a,r=e[0],c=e[1],u=e[2],d=0,p=[];d<r.length;d++)a=r[d],n[a]&&p.push(n[a][0]),n[a]=0;for(i in c)Object.prototype.hasOwnProperty.call(c,i)&&(t[i]=c[i]);l&&l(e);while(p.length)p.shift()();return o.push.apply(o,u||[]),s()}function s(){for(var t,e=0;e<o.length;e++){for(var s=o[e],i=!0,r=1;r<s.length;r++){var c=s[r];0!==n[c]&&(i=!1)}i&&(o.splice(e--,1),t=a(a.s=s[0]))}return t}var i={},n={member_visit_entry:0},o=[];function a(e){if(i[e])return i[e].exports;var s=i[e]={i:e,l:!1,exports:{}};return t[e].call(s.exports,s,s.exports,a),s.l=!0,s.exports}a.m=t,a.c=i,a.d=function(t,e,s){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},a.r=function(t){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(t,e){if(1&e&&(t=a(t)),8&e)return t;if(4&e&&"object"===typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)a.d(s,i,function(e){return t[e]}.bind(null,i));return s},a.n=function(t){var e=t&&t.__esModule?function(){return t["default"]}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="";var r=window["webpackJsonp"]=window["webpackJsonp"]||[],c=r.push.bind(r);r.push=e,r=r.slice();for(var u=0;u<r.length;u++)e(r[u]);var l=c;o.push([40,"chunk-vendors","chunk-common"]),s()})({"27f1":function(t,e,s){"use strict";var i=s("fc1f"),n=s.n(i);n.a},40:function(t,e,s){t.exports=s("b780")},b780:function(t,e,s){"use strict";s.r(e);s("cadf"),s("551c"),s("f751"),s("097d");var i=s("2b0e"),n=function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{attrs:{id:"app"}},[s("div",{staticClass:"recall q-1px-b"},[s("span",[t._v("回访人员")]),s("p",[t._v(t._s(t.recall_name))])]),s("div",{staticClass:"message q-1px-b",on:{click:t.showMessage}},[t._v("\n\t\t会员信息\n\t\t"),t.isShow?t._e():s("span",[t._v(t._s(t.user_name))]),s("i",{class:{selected:t.isShow}})]),t.isShow?s("div",[s("List",{attrs:{list:t.messsges},scopedSlots:t._u([{key:"default",fn:function(e){var i=e.item;e.index;return[i.isHide?t._e():s("div",{staticClass:"message_item q-1px-b"},[s("span",[t._v(t._s(i.title))]),i.phone?s("p",[t._v(t._s(t._f("numFormat")(i.phone)))]):t._e(),i.user_name?s("p",[t._v(t._s(i.user_name))]):t._e(),0===i.sex||1===i.sex?s("p",{staticClass:"sex"},[t._v(t._s(1==i.sex?"男":"女")),s("i",{class:{womem:1!=i.sex}})]):t._e(),i.card_no?s("p",[t._v(t._s(i.card_no))]):t._e(),i.birthday?s("p",{staticClass:"birthday"},[i.age_tag?s("i",[t._v(t._s(i.age_tag))]):t._e(),t._v(t._s(i.birthday))]):t._e()])]}}],null,!1,743501745)})],1):t._e(),s("div",{staticClass:"visit_entry"},[s("List",{attrs:{list:t.themes},scopedSlots:t._u([{key:"default",fn:function(e){var i=e.item,n=e.index;return[i.isHide?t._e():s("div",{staticClass:"message_item q-1px-b"},[s("span",[s("i",{staticClass:"red_star"}),t._v(t._s(i.title))]),s("p",{on:{click:function(e){!i.isNotClick&&t.select(i.type,n)}}},[t._v(t._s(i.select_text||"请选择"))])])]}}])}),s("div",{staticClass:"textarea"},[s("i",{staticClass:"red_star"}),s("textarea",{directives:[{name:"model",rawName:"v-model",value:t.content,expression:"content"}],attrs:{cols:"20",rows:"5",placeholder:"内容描述",maxlength:"100"},domProps:{value:t.content},on:{input:function(e){e.target.composing||(t.content=e.target.value)}}}),s("p",{staticClass:"textarea_number",class:{red:t.content.length>80}},[s("span",[t._v(t._s(t.content.length))]),t._v("/100")])])],1),s("div",{staticClass:"select_coupon"},["yes"!==t.isReceiveUp&&"no"!==t.isConform?s("div",{staticClass:"dispatch_coupon_tip"},[s("span",{staticClass:"dispatch_coupon_icon"}),s("span",[t._v(" 赠他优惠券")])]):t._e(),"yes"!==t.isReceiveUp&&"no"!==t.isConform?s("ul",t._l(t.list,function(e,i){return s("li",{key:e.coupon_batch_id},[s("CouponItem",{staticClass:"coupon_item",attrs:{index:i,item:e},on:{onChangeSelectStatus:t.onChangeSelectStatus,onChangDetailedStatus:t.onChangDetailedStatus}})],1)}),0):t._e(),"yes"===t.isReceiveUp?s("div",{staticClass:"select_coupon_tip"},[t._v("\n\t\t\t（今日卡券派发数量已达到上限）\n\t\t")]):t._e(),"no"===t.isConform?s("div",{staticClass:"select_coupon_tip"},[t._v("\n\t\t\t（该会员没有找到符合条件的卡券可派）\n\t\t")]):t._e()]),s("DispatchCouponConfirm",{attrs:{showDialog:t.showDialog,is_limit:t.is_limit,residual_dispensable_num:t.residual_dispensable_num},on:{onDialogCancel:t.onDialogCancel,onDialogEnter:t.onDialogEnter}}),s("div",{staticClass:"footer_button q-1px-t"},[s("div",{staticClass:"save",class:{"forbin-dispatch-coupon":t.forbinDispatchCoupon},on:{click:t.save}},[t._v("\n\t\t\t"+t._s(t.btnText)+"\n\t\t")])])],1)},o=[],a=(s("ac6a"),s("a3d3")),r=s("b2eb"),c=s("2b61"),u=s("f499"),l=s.n(u),d=s("5d73"),p=s.n(d),h=s("cebc"),_=s("adb5"),f=s("21f4"),m=s("87ad"),v="",g="",C="",b=function(t){var e=a["a"].getParam();g=e.user_id,v=e.detail.phone,C=f["a"].getUUID(),t&&t()},y=function(){window.api.closeWin(),r["a"].publish("customDispatchCouponSuccess")},x=function(t){a["a"].toast(t.message)},w={getCoupon:{baseInfo:{url:"/app/auth/crm/coupon/getCouponlist.do",api_versions:"v1"},getParams:function(t){return Object(h["a"])({user_id:g},t)}},dispatchCoupon:{baseInfo:{url:"/app/auth/crm/coupon/distributeCoupon.do",api_versions:"v1"},getParams:function(t){return Object(h["a"])({},t,{couponVo_list:[{phone:v,user_id:g}],uuid:C})}},getCouponDetail:{baseInfo:{url:"/app/auth/crm/coupon/getCouponDetail.do",api_versions:"v1"},getParams:function(t){return Object(h["a"])({},t)}}},S=function(t,e){for(var s in e)t[s]=e[s];return t},D=function(t){var e=t.type,s=t.success,i=t.error,n=t.param,o={};S(o,w[e].getParams(n));var a={};S(a,w[e].baseInfo),a.data=o,a.success=s,a.error=i,_["a"].ajax(a)},I=function(t){return t=t||[],t.map(function(t){return{product_id:t.product_id,sku_code:t.sku_code}})},L={init:b,requestInterface:D,dispatchCouponSuccess:y,dispatchCouponError:x,getUserDetail:function(){var t=a["a"].getParam().detail||{};return[{title:"会员手机号",phone:t.phone},{title:"会员姓名",user_name:t.user_name},{title:"会员性别",sex:t.sex},{title:"会员卡号",card_no:t.card_no,isHide:!t.card_no},{title:"会员生日",birthday:t.birthday||"--",age_tag:t.ageTag||""}]},getThemeList:function(t,e){var s="",i={};e?(s="/app/auth/crm/care/listAllCrmCares.do",i={type:"usual"}):(s="/app/auth/crm/care/listAllCrmCare.do",i={publish_status:"ongoing"}),_["a"].ajax({data:i,api_versions:"v2",url:s,success:function(e){var s=e.object||[],i={care_names:[],care_ids:[]},n=!0,o=!1,a=void 0;try{for(var r,c=p()(s);!(n=(r=c.next()).done);n=!0){var u=r.value;i.care_names.push(u.title||""),i.care_ids.push(u.care_id||"")}}catch(l){o=!0,a=l}finally{try{n||null==c.return||c.return()}finally{if(o)throw a}}t.success&&t.success(i)},error:function(e){console.log(e),t.error&&t.error()}})},getRedmindProducts:function(t){var e="/app/auth/crm/multiConRedmind/listMCRemindProductDialog.do";_["a"].ajax({data:{user_id:m["a"].getUserId()},api_versions:"v2",url:e,success:function(e){var s=e.object||[];t.success&&t.success(s)},error:function(e){console.log(e),t.error&&t.error()}})},save:function(t){var e=t.data||{},s="/app/auth/crm/care/saveCrmCareVisit.do";e.user_id=m["a"].getUserId(),7==e.care_id&&(e.product_info_list=l()(I(e.product_info_list))),_["a"].ajax({data:e,api_versions:"v2",url:s,success:function(t){console.log(t),r["a"].publish("customRefreshVisitRecord"),a["a"].close("member_visit_entry",{isFrame:!1})},error:function(t){a["a"].toast(t.message,{location:"middle"})}})}},j=s("6abe"),P=s("0cf5"),k=s("b828"),O={name:"visit_entry",components:{List:j["a"],CouponItem:P["a"],DispatchCouponConfirm:k["a"]},data:function(){return{recall_name:"",user_name:"",isShow:!1,messsges:[],care_id:"",type:"",themes:[{title:"主题",type:"theme",select_text:"请选择"},{title:"回访方式",type:"way",select_text:"请选择"},{title:"提醒复购商品",type:"remind",select_text:"请选择",isHide:!0}],themeList:[],themeIdList:[],wayList:["电话","微信","短信","其他"],wayIdList:["phone","wx","msg","other"],content:"",productList:[],list:[{count_rule_operation:"AMOUNT",count_rule_operation_val:0,coupon_title:"",use_rule_val:"",condition:"",goodScope:"商品1、商品2",scope:"部分门店、商城",explain:"新客专用",is_receive:!0,reason_of_unreceive:"",selected:!0,isSpread:!0}],showDialog:!1,currentCouponId:-1,currentIndex:-1,is_dispensable:!1,is_limit:!1,limit_num:0,residual_dispensable_num:0,isReceiveUp:"no",isConform:"yes",isCare:!1}},computed:{showTips:function(){var t=!1;return 0===this.list.length&&(t=!0),t},selectedList:function(){for(var t=[],e=0;e<this.list.length;e++)this.list[e].selected&&t.push(this.list[e]);return t},selectedAmount:function(){return this.selectedList.length},btnText:function(){var t="保存";return 0===this.selectedAmount?t:(t=this.is_limit&&this.selectedAmount>this.residual_dispensable_num?"保存并派券（超过当日派券上限）":"保存并派券（已选择 "+this.selectedAmount+" 张）",t)},forbinDispatchCoupon:function(){return!!(this.is_limit&&this.selectedAmount>this.residual_dispensable_num)}},created:function(){var t=this;L.init(function(){t.list=[],t.getCoupon()})},mounted:function(){var t=this,e=a["a"].getParam();e.theme&&("日常关怀"===e.theme?this.isCare=!0:(this.themes[0].select_text=e.theme,this.themes[0].isNotClick=!0),this.care_id=e.detail.care_id,this.themes[2].isHide=7!=this.care_id),e.way_type&&(this.themes[1].select_text=e.way_type[0],this.themes[1].isNotClick=!0,this.type=e.way_type[1]),this.recall_name=c["a"].val("UserInfo").user_name,this.messsges=L.getUserDetail(),this.user_name=this.messsges[1].user_name,this.getThemeList(),this.getProducts(),r["a"].subscribe("customRefreshRedmindProduct",function(e){t.productList=e.list,t.themes[2].select_text=e.list.length>0?"已选择"+e.list.length+"个":"请选择"})},methods:{onChangDetailedStatus:function(t,e){var s=this;if(!e.isSpread&&!e.isCache)return this.currentCouponId=e.coupon_batch_id,this.currentIndex=t,void L.requestInterface({type:"getCouponDetail",success:function(t){t.success&&t.object&&(s.handleCouponDetail(t.object),s.list[s.currentIndex].isSpread=!0,s.list[s.currentIndex].isCache=!0)},error:function(t){},param:{coupon_batch_id:this.currentCouponId}});e.isSpread=!e.isSpread},onChangeSelectStatus:function(t){t.is_receive&&(t.selected=!t.selected)},onDialogCancel:function(){this.showDialog=!1},onDialogEnter:function(){var t=this;L.requestInterface({type:"dispatchCoupon",success:function(e){if(e.success){L.dispatchCouponSuccess();var s={care_id:t.care_id,type:t.type,content:t.content};7==t.care_id&&(s.product_info_list=t.productList),L.save({data:s})}},error:function(t){},param:{coupon_batch_id:this.getCouponID()}}),this.showDialog=!1},getCouponID:function(){var t=[];return this.list.forEach(function(e){if(e.selected)return t.push(e.coupon_batch_id)}),t},getCoupon:function(){var t=this;L.requestInterface({type:"getCoupon",success:function(e){e.success&&e.object&&(t.handleCouponDispatchStatus(e.object),t.handleCouponData(e.object.couponBatchQueryResultToAppVo))},error:function(t){},param:{}})},handleCouponDispatchStatus:function(t){for(var e=["is_dispensable","is_limit","limit_num","residual_dispensable_num"],s=0;s<e.length;s++){var i=e[s];this[i]=t[i]}},handleCouponData:function(t){var e=this;if(t&&t.count){var s=0;t.detailList.forEach(function(t){t.goodScope="",t.scope="",t.explain="",t.condition="",t.selected=!1,t.isSpread=!1,e.handleCouponUseCondition(t),t.is_receive&&s++}),this.list=t.detailList,0===s&&(this.isConform="no")}else this.isConform="no"},handleCouponUseCondition:function(t){"LIBERTY"===t.count_rule_condition?t.condition="满0元可用":"QUOTA"===t.count_rule_condition&&(t.condition="满"+t.count_rule_condition_val/100+"元可用")},handleCouponDetail:function(t){var e=t.store_products_name||"",s=t.shop_products_name||"";this.list[this.currentIndex].goodScope=e+"、"+s;var i=t.stores_name_for_app||"",n=t.shops_name_brief||"";this.list[this.currentIndex].scope=i+"、"+n,this.list[this.currentIndex].explain=t.remark},getThemeList:function(){var t=this;L.getThemeList({success:function(e){t.themeList=e.care_names,t.themeIdList=e.care_ids}},this.isCare)},getProducts:function(){var t=this;L.getRedmindProducts({success:function(e){t.productList=e,t.themes[2].select_text=e.length>0?"已选择"+e.length+"个":"请选择"}})},showMessage:function(){this.isShow=!this.isShow},select:function(t,e){var s,i=this;if("way"==t)s=this.wayList;else if("theme"==t)s=this.themeList;else{var n="views/member/choose_product";a["a"].openView(n,{param:{bounces:!1,isLightStatusBar:!0,user_id:a["a"].getParam().user_id,productList:this.productList},customNavigationBar:{style:{background:"#4cbdbe",color:"#fff"},url:n+"/header_frame"}})}a["a"].actionSheet({buttons:s},function(n){i.themes[e].select_text=s[n-1],"way"==t?i.type=i.wayIdList[n-1]:"theme"==t&&(i.care_id=i.themeIdList[n-1],i.themes[2].isHide=7!=i.care_id)})},save:function(){if(!this.forbinDispatchCoupon){if(!this.care_id)return a["a"].toast("请选择回访主题",{location:"middle"}),!1;if(!this.type)return a["a"].toast("请选择回访方式",{location:"middle"}),!1;if(7==this.care_id&&0==this.productList.length)return a["a"].toast("请选择提醒复购商品",{location:"middle"}),!1;if(!this.content)return a["a"].toast("请输入回访内容",{location:"middle"}),!1;if(!this.forbinDispatchCoupon){if(this.selectedAmount>0)return this.showDialog=!0;var t={care_id:this.care_id,type:this.type,content:this.content};7==this.care_id&&(t.product_info_list=this.productList),a["a"].confirm("是否确认保存回访记录？",function(){L.save({data:t})})}}}}},T=O,U=(s("27f1"),s("2877")),R=Object(U["a"])(T,n,o,!1,null,"703fe356",null),A=R.exports,q=s("d8ac");i["a"].config.productionTip=!1,q["a"].start(i["a"]),window.EventBus=new i["a"],window.isPc()?(console.log("pc"),new i["a"]({render:function(t){return t(A)},data:{Bus:new i["a"]}}).$mount("#app")):(console.log("移动端"),window.apiready=function(){new i["a"]({render:function(t){return t(A)}}).$mount("#app")})},fc1f:function(t,e,s){}});